# Домашнее задание по дисциплине "Автоматизация администрирования MLOps III".
Выполнял студент 2 курса магистратуры "Инжерения машинного обучения" Карпов Д.В.

Задачи задания: настроить CI/CD-пайплайн для автоматизации сборки проекта, линтинга кода, публикации пакета и документации на GitLab Pages. Также нужно провести разведочный анализ данных (EDA) на предложенном датасете Credit Default и представить результаты в виде отчета. Задание состоит из двух частей: часть 1 - разработка пайплайна, часть 2 - разведочный анализ данных.

Необходимо дать отдельные пояснения по избранному подходу к выполнению задания.
Так, построен CI/CD пайплайн, который выполняет сначала линтинг и форматирование (на стадии format-and-lint) параллельно с предварительной обработкой данных (eda-part), после чего докер-образ под названием notebook-generator формируется с использованием сервиса dind и отправляется в реестр контейнеров Gitlab (image-part). После этого наиболее значимые функции запаковываются и направляются в Gitlab Package Registry (package-part), а ноутбук, сформированный в рамках пайплайна, направляется к размещению на Gitlab Pages (стадия pages).

Нужно отметить, что стадии линтинга и формитирования поставлены параллельно части с предварительным анализом, так как они напрямую не взаимосвязаны, и в то же время до оценки кода и проверки его работоспособности не имеет серьезного смысла отправлять Docker-image в реестр Gitlab.

С другой стороны, в ходе линтинга и форматирования хронологически раньше идет все-таки форматирование, в противном случае гораздо больше шансов, что пайплайн остановится на линтинге, т.е. никакого автоматического форматирования не будет, что делает пайплайн в значительной степени менее осмысленным, а также не соответствует условиям задания.
Кроме того, в пайплайне создание ноутбука и генерация изображений осуществляется путем запуска докер-контейнера, что является своеобразным тестом его работоспособности и тем самым оправдывает включение данной стадии до непосредственной публикации образа в Gitlab Container Registry.

В свою очередь, исходя из контекста задания, а также предложений обрамить весь предварительный анализ данных в одну функцию, был сделан вывод о том, что предполагается получение ноутбука непосредственно в ходе пайплайна. С другой стороны, при получение файлов в рамках Docker-процессов в Gitlab или внутри работающих раннеров в Github Actions такие файлы, если их прямо не закоммитить внутри пайплайна в репозиторий, просто исчезнут, что сведет к минимуму наглядность пайплайна. По итогам изучения вопроса было обнаружено, что в Gitlabe, хотя это и возможно сделать, но только при условии использования project access token, который доступен лишь для платных версий (https://docs.gitlab.com/ee/user/project/settings/project_access_tokens.html), с оплатой подписки на которые имеются определенные проблемы. По этой причине требования задания в значительной части было решено реализовать с использованием механизма Github Actions, в то же время, поскольку задание того требует, была реализована интеграция Github Actions с Gitlab - в части публикации докер-образа, пакета и страницы в Pages.

Соответственно для соединения с гитлаб-аккаунтом использовался механизм secrets в Github Actions (для токенов доступа и иных наименований).

Репозиторий на Gitlab значительно более пуст, т.к. использовался, прежде всего, как интерфейс для доступа к реестру докер-образов, реестру пакетов и Gitlab Pages (ссылка на репозиторий Gitlab https://gitlab.com/dkarpov.legal/dummy_repo.git).

Предварительный анализ выполняется внутри пайплайна, основные функции находятся в папке mymlpackage, на основе которой впоследствии формируется пакет для использования.
Главной функцией является функция nbgenerate.py, которая отвечает за формирование ipynb ноутбуков, а также за исполнение в них ячеек как с сохранением в формат ipynb, так и с преобразованием ноутбука в HTML, пригодный для размещения в Pages. Функция nbgenerate выполняет ноутбук с заранее определенной функцией eda, записанной в файл eda.py, которая последовательно импортирует необходимые модули, в том числе соответствующие конкретным задачам (загрузка, анализ пропусков, анализ корреляций, анализ баланса классов, создание графиков), записанные в самостоятельные .py файлы.

Предварительный анализ производится на датасете Credit Default, который содержится в файле data.csv в папке mymlpackage.

Большинство пояснений и выводов оторбажаются автоматически в ноутбуке. Однако следует отметить, что поскольку функция eda исполняется в одной ячейке и по сути охватывает весь EDA, ввиду чего рекомендуется при открытии ноутбуков в некоторых программах (или при исполнении пайплайна локально в форме докер-контейнеров или Python-пакетов) скорректировать настройки количества строк, отображаемых в выполненных ячейках, чтобы результаты вышли, как планируется.

Вместе с тем включение анализа данных в CI/CD пайплайн имеет смысл лишь в том ключе, если данные могут изменяться. Однако при изменении данных могут поменяться показатели, и выводы будут должны меняться вместе с ними.

В этой связи пайплайн предусматривает возможность введения пользователем самостоятельных выводов в формате консоли (как в формате докер-контейнера, так и в форме пакета при запуске функции nbgenerate.py). При этом поскольку не все среды допускают интерактивный ввод - например, сами раннеры в Github Actions работают именно по такой модели (конечно, можно разделить workflow, ввести переменные, которые вводятся перед запуском программы, но кардинально это вопрос не меняет), а Docker-контейнер может быть запущен в detached mode, то предусмотрен файл colclusions.txt, где содержится вывод "по умолчанию" (актуальный на дату разработки данного пайплайна), который автоматически подтягивается в случае возникновения EOFile исключения. В случае интерактивного ввода пользователь информируется о том, где он может посмотреть графики и диаграммы (папка output_pages/png). При отсутствии интерактивного запроса пользователь может переформулировать выводы в conclusions.txt, откуда они подтянутся при следующем запуске папйлайна.

Пайплайн запускается вручную, по событию workflow_dispatch (что, конечно же, довольно легко перенастроить). Наименование Workflow - Overwrite Repository.

Ссылки на результаты:
- ipynb и HTML варианты результатов предварительного анализа данных есть в репозитории;
- ссылка не репозиторий Gitlab:
```
https://gitlab.com/dkarpov.legal/dummy_repo.git
```
- ссылка на установку пакета из Gitlab Registry:
```
pip install mymlpackage --index-url https://gitlab.com/api/v4/projects/66270948/packages/pypi/simple

```
В данном случае функция запускается путем импорта модуля mymlpackage.nbgenerate
- ссылка на докер-образ:
```
registry.gitlab.com/dkarpov.legal/dummy_repo/notebook-generator
```
- ссылка на документацию в Gitlab Pages:
```
https://dummy-repo-a5c9c9.gitlab.io/
```
